# Проектирование высоконагруженной электронной энциклопедии

## Содержание

- ### [1. Тема, целевая аудитория и функционал](#1_part)
- ### [2. Расчет нагрузки](#2_part)
- ### [3. Глобальная балансировка нагрузки](#3_part)
- ### [Список источников](#sources)

## 1. Тема, целевая аудитория и функционал <a name="1_part"></a>

### Тема

Википедия - это веб-сайт, представляющий собой свободную энциклопедию, которую создают и редактируют добровольцы со всего мира. Это один из крупнейших источников информации в Интернете ввиду своей уникальной модели коллективного редактирования и открытости. Он содержит огромное количество статей по различным темам: от науки и истории до культуры и техники.

### Целевая аудитория

- 133 млн активных пользователей в месяц
- 4.5 млн активных пользователей в день
- 47 млн зарегистрированных пользователей

#### Читатели

- средний возраст - 36 лет
- 55% читателей - мужчины, 45% - женщины

#### Зарегистрированные пользователи

- 84% редакторов - мужчины
- 59% редакторов в возрасте от 17 до 40 лет, а 13% - в возрасте 16 лет и младше

Продукт рассчитан на СНГ рынок, поэтому рассмотрим региональную аудиторию подробнее.

#### Распределение пользователей по странам

| Страна    | %   | чел        |
| --------- | --- | ---------- |
| Россия    | 67  | 89 100 000 |
| Украина   | 11  | 14 600 000 |
| Беларусь  | 4   | 5 300 000  |
| Казахстан | 3   | 4 000 000  |
| Другое    | 15  | 20 000 000 |

### Основной функционал

1. Просмотр статей
2. Создание и редактирование статей
3. Регистрация и аутентификация пользователей
4. Поиск
5. Комментарии

## 2. Расчет нагрузки <a name="2_part"></a>

### Продуктовые метрики

- MAU: 133M
- DAU: 4.5M
- Среднее время на сайте: 00:03:58
- Среднее количество посещенных страниц за сессию: 3.45

#### Среднее количество действий пользователя по типам в день

Рассчитаем количество действий пользователя по следующим типам:

<u>Создание и редактирование статей</u>

Среднее количество правок на страницу равно 20. Таким образом общее количество запросов на создание и обновление статьи в 21 раз больше, чем на создание.

Количество новых статей в день равно 158, следовательно RPD на ручку создания и редактирования статьи равно 158 \* (1 + 20) = 3 318

<u>Поиск</u>

Известно, что среднее количество страниц, посещенных пользователем за одну сессию равно 3,45. На основе личного опыта предположим, что около 1 страницы пользователь находит по поиску, а 2,45 страницы открывает по ссылкам из текущей страницы. Таким образом (1 / 3,45) \* 100% = 29% статей открываются из поиска, а 100% - 29% = 71% открываются по прямым ссылкам.

Отсюда имеем следующее число действий в день: поскольку число просмотренных статей в день равно 30 млн, то число поисковых запросов равно 30 000 000 \* 0,29 = 8 700 000

<u>Комментарии</u>

Для рассчета данных о количестве комментариев воспользуемся статистикой сервиса Дзен, схожего по формату с Википедией. Среднее количество комментариев под постами Дзен равно 40. MAU Дзен равна = 81 000 000. Таким образом, расчитаем предполагаемое количество комментариев под статьями нашего сервиса: 40 \* (133 000 000 / 81 000 000) = 66.

Так как количество новых статей в день равно 158, то число комментариев в день равно 66 \* 158 = 10 428.

| Действие                         | Количество |
| -------------------------------- | ---------- |
| Просмотр статей                  | 30 000 000 |
| Создание + редактирование статей | 3 318      |
| Регистрация и аутентификация     | 310        |
| Поиск                            | 8 700 000  |
| Комментарии                      | 10 428     |

### Технические метрики

#### Общие данные

| Тип                             | Количество |
| ------------------------------- | ---------- |
| Статьи                          | 2 000 000  |
| Загруженные файлы               | 250 000    |
| Изменения статей                | 40 000 000 |
| Зарегистрированные пользователи | 3 500 000  |

#### Размер сущностей

<u>Информация о фотографии</u>

В рекомендациях сайта Википедия указывается, что не стоит загружать фотографии, размер которых превышает 35кб. Примем это за средний размер фотографии.

<u>Информация о профиле</u>

Несмотря на все важные текстовые поля, фото будет составлять бóльшую часть веса, поэтому будем считать, что размер данных профиля равен 40кб.

<u>Информация о статье</u>
Под данным Википедии, среднее количестьво слов в статье на ее ресурсе равно 532, а средняя длина слова - 5 символов. 1 символ в Unicode кодируется 2 байтами.

Поскольку общее число статей на ru.wikipedia.org равно 2 000 000, а количество файлов (фотографий) равно 250 000, то среднее число фотографий в статье равно 250 000 / 2 000 000 = 0,125.

Статья тажкже имеет ID - 16б (UUID).

Итого, имеем: 532 \* 5 \* 2 + 0,125 \* 40 \* 1024 + 16 = 5320 + 5120 + 16 = 10 456б

<u>Информация о комментарии</u>
Примем, что в среднем 1 сообщение содержит 50 символов. 1 символ в Unicode кодируется 2 байтами. Сообщение также имеет ID - 16б, дату создания - 4б и ID статьи - 16б. Итого, имеем 50 \* 2 + 16 + 4 + 16 = 136б.

#### Сводная таблица объема памяти по типовым действиям

| Тип                             | Количество | Объем памяти за все время | Объем памяти за год |
| ------------------------------- | ---------- | ------------------------- | ------------------- |
| Статьи                          | 2 000 000  | 19,47 Гб                  | 575 Мб              |
| Загруженные файлы               | 250 000    | 8,34 Гб                   | 5,05 Гб             |
| Изменения статей                | 40 000 000 | 389,5 Гб                  | 11,34 Гб            |
| Зарегистрированные пользователи | 3 500 000  | 133,5 Гб                  | 4,32 Гб             |
| Комментарии                     | 12 000 000 | 1,52 Гб                   | 494 Мб              |
| Итого                           | -          | 552,33 Гб                 | 21,75 Гб            |

<u>Рассчитаем годовой прирост памяти</u>

Создание статей:

365 \* 158 \* 10 456 = 575 Мб

Изменение статей:

365 \* 158 \* 20 \* 10 456 = 11,34 Гб

Загрузка файлов:

365 \* 415 \* 35 \* 1024 = 5,05 Гб

Регистрация пользователей:

365 \* 310 \* 40 \* 1024 = 4,32 Гб

Комментарии:

365 \* 10 428 \* 136 = 494 Мб

Итого:

0,56 + 11,34 + 5,05 + 4,32 + 0,48 = 21,75 Гб

#### Сетевой трафик

| Тип трафика                      | Пиковое потребление | Средний трафик |
| -------------------------------- | ------------------- | -------------- |
| Просмотр статьи                  | 46,26 Мбит/с        | 27,7 Мбит/с    |
| Загрузка файлов                  | 2,37 Мбит/с         | 1,42 Кбит/с    |
| Создание / редактирование статей | 5,23 Мбит/с         | 3,13 Кбит/с    |
| Регистрация / аутентификация     | 1,9 Мбит/с          | 1,14 Кбит/с    |
| Комментарии                      | 0,33 Мбит/с         | 0,2 Кбит/с     |

<u>Суммарный суточный трафик</u>

Просмотр статьи:

10 456 \* 30 000 000 = 292,14 Гб

Загрузка файлов:

35 \* 1024 \* 415 = 15 Мб

Создание / редактирование статей:

10 456 \* 3 318 = 33 Мб

Регистрация / аутентификация:

40 \* 1024 \* 310 = 12 Мб

Комментарии:

136 \* 10 428 = 2 Мб

Возьмем коэффициент отношения пикового трафика к среднему равным 1,67, и на его основе рассчитаем пиковое потребление.

#### RPS

Вспомним, что по проведенным ранее подсчетам, среднее количество фотографий в статье равно 0,125. Таким образом RPD для загрузки фото равно 3 318 \* 0,125 = 415, следовательно RPS равно 415 / 86 400 = 0,005.

| Тип запроса                      | RPD        | RPS (/ 86 400) |
| -------------------------------- | ---------- | -------------- |
| Просмотр статьи                  | 30 000 000 | 347            |
| Загрузка файлов                  | 415        | 0,005          |
| Создание / редактирование статей | 3 318      | 0,04           |
| Регистрация / аутентификация     | 310        | 0,004          |
| Поиск                            | 8 700 000  | 101            |
| Комментарии                      | 10 428     | 0,12           |

## 3. Глобальная балансировка нагрузки <a name="3_part"></a>

### Расположение датацентров

Так как большая часть аудитории Википедии располагается в России, то все датацентры располагать будем также в России.

Из-за неравномерного распределения плотности населения России большая часть датацентров будет располагаться в европейской части. Но из-за большой протяженности России ЦОД-ы будут находиться также в южной части Сибири и Дальнего Востока в местах наибольшей плотности населения.

Таким образом, города, в которых будут расположены датацентры:

- Москва
- Санкт-Петербург
- Ростов-на-Дону
- Екатеринбург
- Новосибирск
- Хабаровск

### Глобальная балансировка

С помощью GeoDNS будем определять физически ближайший к пользователю ЦОД. ЦОД-ы будут отвечать за следующие районы:

- Хабаровск -> Дальний Восток
- Новосибирск -> Сибирь
- Ростов-на-Дону, Екатеринбург -> Европейская часть России
- Москва -> Москва, Московская область
- Санкт-Петербург -> Санкт-Петербург, Ленинградская область

Затем балансировку можно производить помощью BGP Anycast. Это позволит внутри каждого из районов выбрать наиболее подходящий по маршрутным метрикам ЦОД.

## Список источников <a name="sources"></a>

- ### [Анализ веб-сайта Wikipedia](https://www.similarweb.com/ru/website/ru.wikipedia.org/)

- ### [Анализ действий пользователей Wikipedia](https://pageviews.wmcloud.org/siteviews/?platform=all-access&source=pageviews&agent=user&start=2024-01-25&end=2024-02-25&sites=ru.wikipedia.org)

- https://hypestat.com/info/ru.wikipedia.org

- ### [Wikipedia: размер в томах](https://ru.wikipedia.org/wiki/%D0%92%D0%B8%D0%BA%D0%B8%D0%BF%D0%B5%D0%B4%D0%B8%D1%8F:%D0%A0%D0%B0%D0%B7%D0%BC%D0%B5%D1%80_%D0%B2_%D1%82%D0%BE%D0%BC%D0%B0%D1%85#:~:text=%D0%A1%D0%B5%D0%B3%D0%BE%D0%B4%D0%BD%D1%8F%20%D0%B2%20%D1%80%D1%83%D1%81%D1%81%D0%BA%D0%BE%D0%BC%20%D1%80%D0%B0%D0%B7%D0%B4%D0%B5%D0%BB%D0%B5%20%D0%92%D0%B8%D0%BA%D0%B8%D0%BF%D0%B5%D0%B4%D0%B8%D0%B8,1040119738%20%2F%201955306%20%3D%20532%20%D1%81%D0%BB%D0%BE%D0%B2%D0%B0.)
